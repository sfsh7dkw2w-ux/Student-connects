<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Student Portal</title>

<style>
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;
    background:#eef2f5;
  }
  .topbar{
    background:#2d3e50;
    color:#fff;
    padding:15px;
    text-align:center;
    font-weight:bold;
    font-size:18px;
    cursor:pointer;
    user-select:none;
    -webkit-user-select:none;
  }
  .subbar{
    background:#4f6d8c;
    color:#fff;
    padding:12px;
    text-align:center;
  }
  .container{ padding:15px; }

  .card{
    background:#fff;
    border-radius:12px;
    padding:15px;
    margin-bottom:12px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
  }
  .title{ font-weight:bold; }
  .teacher{ color:#4f6d8c; margin-top:3px; }
  .overall{
    margin-top:8px;
    font-weight:bold;
  }
  .overall small{
    font-weight:normal;
    opacity:0.75;
  }

  .assignment{
    margin-top:10px;
    padding:10px;
    background:#f5f7fa;
    border-radius:10px;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
  }
  .assignmentLeft{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .assignmentName{ font-weight:bold; }
  .assignmentMeta{
    font-size:13px;
    opacity:0.8;
  }

  .login{
    display:flex;
    justify-content:center;
    align-items:center;
    height:80vh;
  }
  .login button{
    padding:14px 24px;
    font-size:16px;
    border-radius:10px;
    border:none;
    background:#2d3e50;
    color:#fff;
    cursor:pointer;
  }
  .login button:hover{ opacity:0.92; }

  .hidden{ display:none !important; }

  /* Modal */
  .modal{
    position:fixed;
    top:0; left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.45);
    display:flex;
    justify-content:center;
    align-items:center;
    padding:16px;
    z-index:999;
  }
  .modal-content{
    width:100%;
    max-width:560px;
    background:#fff;
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
    padding:18px;
  }
  .modal-title{
    font-weight:bold;
    font-size:18px;
    margin-bottom:6px;
  }
  .modal-sub{
    font-size:12px;
    opacity:0.75;
    margin-bottom:10px;
    line-height:1.35;
  }

  .modal-content input,
  .modal-content select{
    width:100%;
    box-sizing:border-box;
    padding:12px;
    margin-top:10px;
    border-radius:10px;
    border:1px solid #cfd8e3;
    font-size:15px;
    outline:none;
  }

  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .row .col{
    flex:1 1 140px;
    min-width:140px;
  }

  .btnRow{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:12px;
  }
  .btnRow button{
    flex:1 1 160px;
    padding:12px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold;
  }
  .primaryBtn{ background:#2d3e50; color:#fff; }
  .mutedBtn{ background:#e7ecf2; color:#1f2a33; }
  .dangerBtn{ background:#c4001a; color:#fff; }

  .errorText{
    margin-top:10px;
    color:#c4001a;
    font-weight:bold;
    font-size:13px;
  }

  /* Admin assignment list */
  .adminList{
    margin-top:12px;
    border-top:1px solid #eef2f5;
    padding-top:10px;
  }
  .adminItem{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
    padding:10px;
    background:#f7f9fc;
    border:1px solid #e6edf5;
    border-radius:10px;
    margin-top:10px;
  }
  .adminItemLeft{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .adminItemName{ font-weight:bold; }
  .adminItemMeta{ font-size:13px; opacity:0.8; }

  .adminItemBtns{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .miniBtn{
    border:none;
    border-radius:10px;
    padding:8px 10px;
    cursor:pointer;
    font-weight:bold;
  }
  .miniEdit{ background:#2d3e50; color:#fff; }
  .miniDel{ background:#c4001a; color:#fff; }
</style>
</head>

<body>
  <div class="topbar" id="header">Dearborn Public Schools</div>
  <div class="subbar">Assignments</div>

  <div class="container">
    <div id="login" class="login">
      <button id="loginBtn">Sign In</button>
    </div>

    <div id="dashboard" class="hidden"></div>
  </div>

  <!-- Admin Modal (hidden on load) -->
  <div id="adminModal" class="modal hidden" hidden style="display:none;">
    <div class="modal-content" id="adminModalBox">
      <div class="modal-title">Admin</div>
      <div class="modal-sub">
        Admin mode is required to add/edit/delete assignments and override class grades.
      </div>

      <!-- Step 1: Password -->
      <div id="adminStepPass">
        <input id="adminPassInput" type="password" placeholder="Enter admin password" inputmode="numeric" />
        <div class="btnRow">
          <button class="primaryBtn" id="adminUnlockBtn">Unlock</button>
          <button class="mutedBtn" id="adminCloseBtn1">Close</button>
        </div>
        <div id="adminPassErr" class="errorText hidden">Incorrect password.</div>
      </div>

      <!-- Step 2: Tools -->
      <div id="adminStepTools" class="hidden">
        <select id="classSelect"></select>

        <!-- Override grade -->
        <input id="overrideInput" type="text" placeholder="Override overall grade (optional, ex: A-)" />
        <div class="btnRow">
          <button class="primaryBtn" id="saveOverride">Save Override</button>
          <button class="mutedBtn" id="clearOverride">Clear Override</button>
        </div>

        <!-- Add / Edit assignment -->
        <input id="assignName" type="text" placeholder="Assignment name (ex: Homework 1)" />
        <div class="row">
          <div class="col">
            <input id="earnedInput" type="number" min="0" step="0.01" placeholder="Points earned (ex: 18)" />
          </div>
          <div class="col">
            <input id="possibleInput" type="number" min="0.01" step="0.01" placeholder="Points possible (ex: 20)" />
          </div>
        </div>

        <div class="btnRow">
          <button class="primaryBtn" id="saveAssignBtn">Save Assignment</button>
          <button class="mutedBtn" id="clearFormBtn">Clear</button>
          <button class="mutedBtn" id="adminCloseBtn2">Close</button>
        </div>

        <div class="btnRow">
          <button class="dangerBtn" id="exitAdminBtn">Exit Admin Mode</button>
        </div>

        <!-- Assignment list (admin only) -->
        <div class="adminList">
          <div style="font-weight:bold;">Assignments (Admin)</div>
          <div id="adminAssignList"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== CONFIG =====
  var ADMIN_PASSWORD = "20126693";
  var isAdminUnlocked = false; // controls ALL edits/deletes/overrides

  var classes = [
    {id:1,name:"Chemistry S2",teacher:"Bazzi-Hijazi, R"},
    {id:2,name:"Arabic 2 S2",teacher:"Raishouni, O"},
    {id:3,name:"PE/Health 9 Boys",teacher:"Hamade, M"},
    {id:4,name:"Language Arts 2",teacher:"Marwani, H"},
    {id:5,name:"AP Human Geography",teacher:"Jedele, S"},
    {id:6,name:"Algebra 2 S2",teacher:"AlHadrawi, M"}
  ];

  // ===== ELEMENTS =====
  var login = document.getElementById("login");
  var loginBtn = document.getElementById("loginBtn");
  var dashboard = document.getElementById("dashboard");
  var header = document.getElementById("header");

  var adminModal = document.getElementById("adminModal");
  var adminModalBox = document.getElementById("adminModalBox");
  var adminStepPass = document.getElementById("adminStepPass");
  var adminStepTools = document.getElementById("adminStepTools");

  var adminPassInput = document.getElementById("adminPassInput");
  var adminPassErr = document.getElementById("adminPassErr");
  var adminUnlockBtn = document.getElementById("adminUnlockBtn");
  var adminCloseBtn1 = document.getElementById("adminCloseBtn1");
  var adminCloseBtn2 = document.getElementById("adminCloseBtn2");
  var exitAdminBtn = document.getElementById("exitAdminBtn");

  var classSelect = document.getElementById("classSelect");
  var overrideInput = document.getElementById("overrideInput");
  var saveOverride = document.getElementById("saveOverride");
  var clearOverride = document.getElementById("clearOverride");

  var assignName = document.getElementById("assignName");
  var earnedInput = document.getElementById("earnedInput");
  var possibleInput = document.getElementById("possibleInput");
  var saveAssignBtn = document.getElementById("saveAssignBtn");
  var clearFormBtn = document.getElementById("clearFormBtn");

  var adminAssignList = document.getElementById("adminAssignList");

  // Edit state (admin only)
  var editingIndex = null; // number or null

  // ===== Always start with admin hidden =====
  forceHideAdmin();

  function forceHideAdmin(){
    adminModal.classList.add("hidden");
    adminModal.setAttribute("hidden","hidden");
    adminModal.style.display = "none";
  }
  function showAdmin(){
    adminModal.classList.remove("hidden");
    adminModal.removeAttribute("hidden");
    adminModal.style.display = "flex";
  }
  function closeAdminModal(){
    // Closing the modal LOCKS admin (safer).
    // You can always re-open with 5 taps.
    exitAdminMode();
  }
  function exitAdminMode(){
    isAdminUnlocked = false;
    editingIndex = null;
    resetAssignmentForm();
    forceHideAdmin();
    render(); // removes any admin-only visibility
  }

  // ===== LOGIN =====
  loginBtn.addEventListener("click", function(){
    login.classList.add("hidden");
    dashboard.classList.remove("hidden");
    render();
  });

  // ===== Storage helpers =====
  function safeParse(json, fallback){
    try { return JSON.parse(json); } catch(e){ return fallback; }
  }
  function getAssignments(classId){
    return safeParse(localStorage.getItem("assign_" + classId), []);
  }
  function setAssignments(classId, arr){
    localStorage.setItem("assign_" + classId, JSON.stringify(arr));
  }
  function getOverride(classId){
    var v = localStorage.getItem("override_" + classId);
    return v ? String(v) : "";
  }
  function setOverrideValue(classId, v){
    v = String(v || "").trim();
    if(!v){
      localStorage.removeItem("override_" + classId);
    } else {
      localStorage.setItem("override_" + classId, v);
    }
  }

  // ===== Grade calculations =====
  function computePercent(assignments){
    var earnedSum = 0;
    var possibleSum = 0;

    for(var i=0;i<assignments.length;i++){
      var a = assignments[i];
      var earned = Number(a.earned);
      var possible = Number(a.possible);

      if(!isFinite(earned) || !isFinite(possible)) continue;
      if(possible <= 0) continue;

      earnedSum += earned;
      possibleSum += possible;
    }

    if(possibleSum <= 0) return null;
    return (earnedSum / possibleSum) * 100;
  }

  function letterFromPercent(p){
    if(p === null) return "--";
    if(p >= 93) return "A";
    if(p >= 90) return "A-";
    if(p >= 87) return "B+";
    if(p >= 83) return "B";
    if(p >= 80) return "B-";
    if(p >= 77) return "C+";
    if(p >= 73) return "C";
    if(p >= 70) return "C-";
    if(p >= 67) return "D+";
    if(p >= 63) return "D";
    if(p >= 60) return "D-";
    return "F";
  }

  function formatPercent(p){
    if(p === null) return "--";
    return (Math.round(p * 10) / 10).toFixed(1) + "%";
  }

  // ===== Render dashboard (READ-ONLY for non-admin) =====
  function render(){
    dashboard.innerHTML = "";

    for(var i=0;i<classes.length;i++){
      var c = classes[i];
      var assignments = getAssignments(c.id);

      var percent = computePercent(assignments);
      var computedLetter = letterFromPercent(percent);

      var override = getOverride(c.id);
      var overallLetter = override ? override : computedLetter;

      var card = document.createElement("div");
      card.className = "card";

      var overallLine =
        "<div class='overall'>Overall: " + escapeHtml(overallLetter) +
        " <small>(" + escapeHtml(formatPercent(percent)) + (override ? " • overridden" : "") + ")</small></div>";

      card.innerHTML =
        "<div class='title'>" + escapeHtml(c.name) + "</div>" +
        "<div class='teacher'>" + escapeHtml(c.teacher) + "</div>" +
        overallLine +
        "<div id='assign_" + c.id + "'></div>";

      dashboard.appendChild(card);

      var container = document.getElementById("assign_" + c.id);

      if(assignments.length === 0){
        var empty = document.createElement("div");
        empty.style.opacity = "0.7";
        empty.style.marginTop = "10px";
        empty.textContent = "No assignments yet.";
        container.appendChild(empty);
      } else {
        for(var j=0;j<assignments.length;j++){
          addAssignmentRow(container, assignments[j]);
        }
      }
    }

    // If admin is open/unlocked, refresh admin list too
    if(isAdminUnlocked && !adminStepTools.classList.contains("hidden")){
      renderAdminAssignmentList();
    }
  }

  // Dashboard assignment row is READ-ONLY (no edit/delete controls exist here)
  function addAssignmentRow(container, a){
    var div = document.createElement("div");
    div.className = "assignment";

    var left = document.createElement("div");
    left.className = "assignmentLeft";

    var name = document.createElement("div");
    name.className = "assignmentName";
    name.textContent = a.name;

    var meta = document.createElement("div");
    meta.className = "assignmentMeta";

    var earned = Number(a.earned);
    var possible = Number(a.possible);
    var pctText = "--";
    if(isFinite(earned) && isFinite(possible) && possible > 0){
      var pct = (earned/possible) * 100;
      pctText = (Math.round(pct*10)/10).toFixed(1) + "%";
    }
    meta.textContent = String(a.earned) + " / " + String(a.possible) + "  •  " + pctText;

    left.appendChild(name);
    left.appendChild(meta);

    div.appendChild(left);
    container.appendChild(div);
  }

  function escapeHtml(s){
    s = String(s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
            .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  // ===== ADMIN trigger: 5 taps on header (iOS safe) =====
  var tapCount = 0;
  var tapTimer = null;
  var lastTouchTime = 0;

  function registerTap(){
    tapCount++;
    if(tapTimer) clearTimeout(tapTimer);
    tapTimer = setTimeout(function(){ tapCount = 0; }, 2000);

    if(tapCount >= 5){
      tapCount = 0;
      openAdmin();
    }
  }

  header.addEventListener("touchend", function(e){
    e.preventDefault();
    lastTouchTime = Date.now();
    registerTap();
  }, {passive:false});

  header.addEventListener("click", function(){
    if(Date.now() - lastTouchTime < 600) return; // ignore ghost click
    registerTap();
  });

  function openAdmin(){
    // reset modal state (locked until password correct)
    isAdminUnlocked = false;
    editingIndex = null;
    resetAssignmentForm();

    adminPassInput.value = "";
    adminPassErr.classList.add("hidden");

    adminStepPass.classList.remove("hidden");
    adminStepTools.classList.add("hidden");

    // show modal
    showAdmin();
    setTimeout(function(){ adminPassInput.focus(); }, 50);
  }

  // Close actions
  adminCloseBtn1.addEventListener("click", closeAdminModal);
  adminCloseBtn2.addEventListener("click", closeAdminModal);

  adminModal.addEventListener("click", function(e){
    if(e.target === adminModal) closeAdminModal();
  });
  adminModalBox.addEventListener("click", function(e){
    e.stopPropagation();
  });

  exitAdminBtn.addEventListener("click", function(){
    exitAdminMode();
  });

  // Unlock admin
  adminUnlockBtn.addEventListener("click", function(){
    var pass = (adminPassInput.value || "").replace(/\s+/g,"");
    if(pass !== ADMIN_PASSWORD){
      adminPassErr.classList.remove("hidden");
      return;
    }
    adminPassErr.classList.add("hidden");

    isAdminUnlocked = true;

    // populate class dropdown
    classSelect.innerHTML = "";
    for(var i=0;i<classes.length;i++){
      var opt = document.createElement("option");
      opt.value = String(classes[i].id);
      opt.textContent = classes[i].id + " - " + classes[i].name;
      classSelect.appendChild(opt);
    }

    // load override for selected class
    overrideInput.value = getOverride(classSelect.value);

    adminStepPass.classList.add("hidden");
    adminStepTools.classList.remove("hidden");

    renderAdminAssignmentList();
    render(); // dashboard stays read-only but reflects any stored values
    setTimeout(function(){ assignName.focus(); }, 50);
  });

  // When class changes in admin
  classSelect.addEventListener("change", function(){
    if(!isAdminUnlocked) return;
    overrideInput.value = getOverride(classSelect.value);
    editingIndex = null;
    resetAssignmentForm();
    renderAdminAssignmentList();
  });

  // ===== Admin: Override grade (admin only) =====
  saveOverride.addEventListener("click", function(){
    if(!isAdminUnlocked) return;
    var classId = classSelect.value;
    var v = (overrideInput.value || "").trim();
    if(!v){
      alert("Type a letter grade (ex: A-, B+), or use Clear Override.");
      return;
    }
    setOverrideValue(classId, v);
    render();
  });

  clearOverride.addEventListener("click", function(){
    if(!isAdminUnlocked) return;
    var classId = classSelect.value;
    setOverrideValue(classId, "");
    overrideInput.value = "";
    render();
  });

  // ===== Admin: Add / Edit assignment (admin only) =====
  function resetAssignmentForm(){
    assignName.value = "";
    earnedInput.value = "";
    possibleInput.value = "";
    saveAssignBtn.textContent = "Save Assignment";
    editingIndex = null;
  }

  clearFormBtn.addEventListener("click", function(){
    if(!isAdminUnlocked) return;
    resetAssignmentForm();
  });

  saveAssignBtn.addEventListener("click", function(){
    if(!isAdminUnlocked) return;

    var classId = classSelect.value;
    var name = (assignName.value || "").trim();
    var earned = Number(earnedInput.value);
    var possible = Number(possibleInput.value);

    if(!name){ alert("Enter an assignment name."); return; }
    if(!isFinite(earned) || earned < 0){ alert("Points earned must be a valid number ≥ 0."); return; }
    if(!isFinite(possible) || possible <= 0){ alert("Points possible must be a valid number > 0."); return; }

    var arr = getAssignments(classId);

    if(editingIndex === null){
      // ADD
      arr.push({ name:name, earned:earned, possible:possible });
    } else {
      // EDIT
      if(editingIndex < 0 || editingIndex >= arr.length){
        alert("That assignment no longer exists. Refreshing list.");
        editingIndex = null;
        renderAdminAssignmentList();
        return;
      }
      arr[editingIndex] = { name:name, earned:earned, possible:possible };
    }

    setAssignments(classId, arr);
    resetAssignmentForm();
    renderAdminAssignmentList();
    render();
  });

  // ===== Admin: assignment list with edit/delete (admin only) =====
  function renderAdminAssignmentList(){
    if(!isAdminUnlocked) return;

    var classId = classSelect.value;
    var arr = getAssignments(classId);

    adminAssignList.innerHTML = "";

    if(arr.length === 0){
      var empty = document.createElement("div");
      empty.style.opacity = "0.75";
      empty.style.marginTop = "10px";
      empty.textContent = "No assignments for this class.";
      adminAssignList.appendChild(empty);
      return;
    }

    for(var i=0;i<arr.length;i++){
      (function(idx){
        var a = arr[idx];

        var item = document.createElement("div");
        item.className = "adminItem";

        var left = document.createElement("div");
        left.className = "adminItemLeft";

        var n = document.createElement("div");
        n.className = "adminItemName";
        n.textContent = a.name;

        var m = document.createElement("div");
        m.className = "adminItemMeta";

        var earned = Number(a.earned);
        var possible = Number(a.possible);
        var pctText = "--";
        if(isFinite(earned) && isFinite(possible) && possible > 0){
          var pct = (earned/possible) * 100;
          pctText = (Math.round(pct*10)/10).toFixed(1) + "%";
        }
        m.textContent = String(a.earned) + " / " + String(a.possible) + "  •  " + pctText;

        left.appendChild(n);
        left.appendChild(m);

        var btns = document.createElement("div");
        btns.className = "adminItemBtns";

        var editBtn = document.createElement("button");
        editBtn.className = "miniBtn miniEdit";
        editBtn.textContent = "Edit";
        editBtn.addEventListener("click", function(){
          if(!isAdminUnlocked) return;
          editingIndex = idx;
          assignName.value = a.name;
          earnedInput.value = a.earned;
          possibleInput.value = a.possible;
          saveAssignBtn.textContent = "Update Assignment";
          setTimeout(function(){ assignName.focus(); }, 50);
        });

        var delBtn = document.createElement("button");
        delBtn.className = "miniBtn miniDel";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", function(){
          if(!isAdminUnlocked) return;
          var ok = confirm("Delete this assignment?");
          if(!ok) return;

          var arr2 = getAssignments(classId);
          if(idx < 0 || idx >= arr2.length) return;
          arr2.splice(idx, 1);
          setAssignments(classId, arr2);

          // if we deleted the one being edited, reset form
          if(editingIndex === idx){
            resetAssignmentForm();
          }
          // if deleted earlier index, shift editingIndex down
          if(editingIndex !== null && idx < editingIndex){
            editingIndex = editingIndex - 1;
          }

          renderAdminAssignmentList();
          render();
        });

        btns.appendChild(editBtn);
        btns.appendChild(delBtn);

        item.appendChild(left);
        item.appendChild(btns);

        adminAssignList.appendChild(item);
      })(i);
    }
  }

})();
</script>
</body>
</html>
