<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Student Portal</title>

<style>
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;
    background:#eef2f5;
  }
  .topbar{
    background:#2d3e50;
    color:#fff;
    padding:15px;
    text-align:center;
    font-weight:bold;
    font-size:18px;
    cursor:pointer;
    user-select:none;
    -webkit-user-select:none;
  }
  .subbar{
    background:#4f6d8c;
    color:#fff;
    padding:12px;
    text-align:center;
  }
  .container{ padding:15px; }

  .card{
    background:#fff;
    border-radius:12px;
    padding:15px;
    margin-bottom:12px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
  }
  .title{ font-weight:bold; }
  .teacher{ color:#4f6d8c; margin-top:3px; }
  .overall{
    margin-top:8px;
    font-weight:bold;
  }
  .overall small{
    font-weight:normal;
    opacity:0.75;
  }

  .assignment{
    margin-top:8px;
    padding:10px;
    background:#f5f7fa;
    border-radius:10px;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
  }
  .assignmentLeft{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .assignmentName{
    font-weight:bold;
  }
  .assignmentMeta{
    font-size:13px;
    opacity:0.8;
  }
  .deleteX{
    cursor:pointer;
    color:#c4001a;
    font-weight:bold;
    padding:4px 10px;
    border-radius:10px;
    line-height:1.2;
    user-select:none;
    -webkit-user-select:none;
  }
  .deleteX:hover{ background:#fdecef; }

  .login{
    display:flex;
    justify-content:center;
    align-items:center;
    height:80vh;
  }
  .login button{
    padding:14px 24px;
    font-size:16px;
    border-radius:10px;
    border:none;
    background:#2d3e50;
    color:#fff;
    cursor:pointer;
  }
  .login button:hover{ opacity:0.92; }

  .hidden{ display:none !important; }

  /* Modal */
  .modal{
    position:fixed;
    top:0; left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.45);
    display:flex;
    justify-content:center;
    align-items:center;
    padding:16px;
    z-index:999;
  }
  .modal-content{
    width:100%;
    max-width:520px;
    background:#fff;
    border-radius:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.25);
    padding:18px;
  }
  .modal-title{
    font-weight:bold;
    font-size:18px;
    margin-bottom:8px;
  }
  .modal-sub{
    font-size:12px;
    opacity:0.75;
    margin-bottom:10px;
    line-height:1.35;
  }
  .modal-content input,
  .modal-content select{
    width:100%;
    box-sizing:border-box;
    padding:12px;
    margin-top:10px;
    border-radius:10px;
    border:1px solid #cfd8e3;
    font-size:15px;
    outline:none;
  }
  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .row .col{
    flex:1 1 140px;
    min-width:140px;
  }
  .modal-row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:12px;
  }
  .modal-row button{
    flex:1 1 140px;
    padding:12px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold;
  }
  .saveBtn{ background:#2d3e50; color:#fff; }
  .closeBtn{ background:#e7ecf2; color:#1f2a33; }
  .dangerBtn{ background:#c4001a; color:#fff; }
  .errorText{
    margin-top:10px;
    color:#c4001a;
    font-weight:bold;
    font-size:13px;
  }
</style>
</head>

<body>
  <div class="topbar" id="header">Dearborn Public Schools</div>
  <div class="subbar">Assignments</div>

  <div class="container">
    <div id="login" class="login">
      <button id="loginBtn">Sign In</button>
    </div>

    <div id="dashboard" class="hidden"></div>
  </div>

  <!-- Admin Modal (hidden on load) -->
  <div id="adminModal" class="modal hidden" hidden style="display:none;">
    <div class="modal-content" id="adminModalBox">
      <div class="modal-title">Admin</div>
      <div class="modal-sub">
        Admin mode is required to delete assignments or change overall grades.
      </div>

      <!-- Step 1: Password -->
      <div id="adminStepPass">
        <input id="adminPassInput" type="password" placeholder="Enter admin password" inputmode="numeric" />
        <div class="modal-row">
          <button class="saveBtn" id="adminUnlockBtn">Unlock</button>
          <button class="closeBtn" id="adminCloseBtn1">Close</button>
        </div>
        <div id="adminPassErr" class="errorText hidden">Incorrect password.</div>
      </div>

      <!-- Step 2: Admin tools -->
      <div id="adminStepTools" class="hidden">
        <select id="classSelect"></select>

        <!-- Add assignment -->
        <input id="assignName" type="text" placeholder="Assignment name (ex: Homework 1)" />

        <div class="row">
          <div class="col">
            <input id="earnedInput" type="number" min="0" step="0.01" placeholder="Points earned (ex: 18)" />
          </div>
          <div class="col">
            <input id="possibleInput" type="number" min="0.01" step="0.01" placeholder="Points possible (ex: 20)" />
          </div>
        </div>

        <div class="modal-row">
          <button class="saveBtn" id="saveAssign">Save Assignment</button>
          <button class="closeBtn" id="adminCloseBtn2">Close</button>
        </div>

        <!-- Override grade -->
        <input id="overrideInput" type="text" placeholder="Override overall grade (optional, ex: A-)" />
        <div class="modal-row">
          <button class="saveBtn" id="saveOverride">Save Override</button>
          <button class="closeBtn" id="clearOverride">Clear Override</button>
        </div>

        <div class="modal-row">
          <button class="dangerBtn" id="exitAdmin">Exit Admin Mode</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== CONFIG =====
  var ADMIN_PASSWORD = "20126693";
  var isAdminUnlocked = false; // controls delete/override permissions

  var classes = [
    {id:1,name:"Chemistry S2",teacher:"Bazzi-Hijazi, R"},
    {id:2,name:"Arabic 2 S2",teacher:"Raishouni, O"},
    {id:3,name:"PE/Health 9 Boys",teacher:"Hamade, M"},
    {id:4,name:"Language Arts 2",teacher:"Marwani, H"},
    {id:5,name:"AP Human Geography",teacher:"Jedele, S"},
    {id:6,name:"Algebra 2 S2",teacher:"AlHadrawi, M"}
  ];

  // ===== ELEMENTS =====
  var login = document.getElementById("login");
  var loginBtn = document.getElementById("loginBtn");
  var dashboard = document.getElementById("dashboard");
  var header = document.getElementById("header");

  var adminModal = document.getElementById("adminModal");
  var adminModalBox = document.getElementById("adminModalBox");

  var adminStepPass = document.getElementById("adminStepPass");
  var adminStepTools = document.getElementById("adminStepTools");

  var adminPassInput = document.getElementById("adminPassInput");
  var adminPassErr = document.getElementById("adminPassErr");
  var adminUnlockBtn = document.getElementById("adminUnlockBtn");
  var adminCloseBtn1 = document.getElementById("adminCloseBtn1");
  var adminCloseBtn2 = document.getElementById("adminCloseBtn2");

  var classSelect = document.getElementById("classSelect");
  var assignName = document.getElementById("assignName");
  var earnedInput = document.getElementById("earnedInput");
  var possibleInput = document.getElementById("possibleInput");
  var saveAssign = document.getElementById("saveAssign");

  var overrideInput = document.getElementById("overrideInput");
  var saveOverride = document.getElementById("saveOverride");
  var clearOverride = document.getElementById("clearOverride");
  var exitAdmin = document.getElementById("exitAdmin");

  // ===== SAFE MODAL HIDE ON LOAD =====
  forceHideAdmin();

  function forceHideAdmin(){
    adminModal.classList.add("hidden");
    adminModal.setAttribute("hidden","hidden");
    adminModal.style.display = "none";
  }
  function showAdmin(){
    adminModal.classList.remove("hidden");
    adminModal.removeAttribute("hidden");
    adminModal.style.display = "flex";
  }
  function closeAdminModal(){
    forceHideAdmin();
  }
  function exitAdminMode(){
    isAdminUnlocked = false;
    closeAdminModal();
    render(); // ensure delete buttons disappear
  }

  // ===== LOGIN =====
  loginBtn.addEventListener("click", function(){
    login.classList.add("hidden");
    dashboard.classList.remove("hidden");
    render();
  });

  // ===== STORAGE HELPERS =====
  function getAssignments(classId){
    return safeParse(localStorage.getItem("assign_" + classId), []);
  }
  function setAssignments(classId, arr){
    localStorage.setItem("assign_" + classId, JSON.stringify(arr));
  }

  function getOverride(classId){
    var v = localStorage.getItem("override_" + classId);
    return v ? String(v) : "";
  }
  function setOverride(classId, v){
    v = String(v || "").trim();
    if(!v){
      localStorage.removeItem("override_" + classId);
    } else {
      localStorage.setItem("override_" + classId, v);
    }
  }

  function safeParse(json, fallback){
    try { return JSON.parse(json); } catch(e){ return fallback; }
  }

  // ===== GRADE CALCS =====
  function computePercent(assignments){
    var earnedSum = 0;
    var possibleSum = 0;

    for(var i=0;i<assignments.length;i++){
      var a = assignments[i];
      var earned = Number(a.earned);
      var possible = Number(a.possible);

      if(!isFinite(earned) || !isFinite(possible)) continue;
      if(possible <= 0) continue;

      earnedSum += earned;
      possibleSum += possible;
    }

    if(possibleSum <= 0) return null;
    return (earnedSum / possibleSum) * 100;
  }

  function letterFromPercent(p){
    if(p === null) return "--";
    if(p >= 93) return "A";
    if(p >= 90) return "A-";
    if(p >= 87) return "B+";
    if(p >= 83) return "B";
    if(p >= 80) return "B-";
    if(p >= 77) return "C+";
    if(p >= 73) return "C";
    if(p >= 70) return "C-";
    if(p >= 67) return "D+";
    if(p >= 63) return "D";
    if(p >= 60) return "D-";
    return "F";
  }

  function formatPercent(p){
    if(p === null) return "--";
    return (Math.round(p * 10) / 10).toFixed(1) + "%";
  }

  // ===== RENDER =====
  function render(){
    dashboard.innerHTML = "";

    for(var i=0;i<classes.length;i++){
      var c = classes[i];
      var assignments = getAssignments(c.id);

      var percent = computePercent(assignments);
      var computedLetter = letterFromPercent(percent);

      var override = getOverride(c.id);
      var overallLetter = override ? override : computedLetter;

      var card = document.createElement("div");
      card.className = "card";

      var overallLine =
        "<div class='overall'>Overall: " + escapeHtml(overallLetter) +
        " <small>(" + escapeHtml(formatPercent(percent)) + (override ? " • overridden" : "") + ")</small></div>";

      card.innerHTML =
        "<div class='title'>" + escapeHtml(c.name) + "</div>" +
        "<div class='teacher'>" + escapeHtml(c.teacher) + "</div>" +
        overallLine +
        "<div id='assign_" + c.id + "'></div>";

      dashboard.appendChild(card);

      var container = document.getElementById("assign_" + c.id);

      if(assignments.length === 0){
        var empty = document.createElement("div");
        empty.style.opacity = "0.7";
        empty.style.marginTop = "10px";
        empty.textContent = "No assignments yet.";
        container.appendChild(empty);
      } else {
        for(var j=0;j<assignments.length;j++){
          addAssignmentRow(container, c.id, assignments[j], j);
        }
      }
    }
  }

  function addAssignmentRow(container, classId, a, index){
    var div = document.createElement("div");
    div.className = "assignment";

    var left = document.createElement("div");
    left.className = "assignmentLeft";

    var name = document.createElement("div");
    name.className = "assignmentName";
    name.textContent = a.name;

    var meta = document.createElement("div");
    meta.className = "assignmentMeta";

    var earned = Number(a.earned);
    var possible = Number(a.possible);
    var pctText = "--";
    if(isFinite(earned) && isFinite(possible) && possible > 0){
      var pct = (earned/possible) * 100;
      pctText = (Math.round(pct*10)/10).toFixed(1) + "%";
    }
    meta.textContent = String(a.earned) + " / " + String(a.possible) + "  •  " + pctText;

    left.appendChild(name);
    left.appendChild(meta);
    div.appendChild(left);

    // ONLY show delete button if admin is unlocked
    if(isAdminUnlocked){
      var del = document.createElement("span");
      del.className = "deleteX";
      del.textContent = "✕";
      del.setAttribute("data-action", "delete");
      del.setAttribute("data-class", String(classId));
      del.setAttribute("data-index", String(index));
      div.appendChild(del);
    }

    container.appendChild(div);
  }

  function escapeHtml(s){
    s = String(s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
            .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  // ===== DELETE (ADMIN ONLY, STRICT) =====
  document.addEventListener("click", function(e){
    var t = e.target;
    if(!t || !t.getAttribute) return;

    // Only delete if:
    // 1) admin unlocked
    // 2) clicked element is deleteX with data-action="delete"
    if(!isAdminUnlocked) return;
    if(!t.classList || !t.classList.contains("deleteX")) return;
    if(t.getAttribute("data-action") !== "delete") return;

    var classId = t.getAttribute("data-class");
    var index = Number(t.getAttribute("data-index"));
    if(!classId || !isFinite(index)) return;

    var arr = getAssignments(classId);
    if(index < 0 || index >= arr.length) return;

    arr.splice(index, 1);
    setAssignments(classId, arr);
    render();
  });

  // ===== ADMIN TRIGGER: 5 TAPS ON HEADER (iOS SAFE) =====
  var tapCount = 0;
  var tapTimer = null;
  var lastTouchTime = 0;

  function registerTap(){
    tapCount++;
    if(tapTimer) clearTimeout(tapTimer);
    tapTimer = setTimeout(function(){ tapCount = 0; }, 2000);

    if(tapCount >= 5){
      tapCount = 0;
      openAdmin();
    }
  }

  header.addEventListener("touchend", function(e){
    e.preventDefault();
    lastTouchTime = Date.now();
    registerTap();
  }, {passive:false});

  header.addEventListener("click", function(){
    if(Date.now() - lastTouchTime < 600) return; // ignore ghost click
    registerTap();
  });

  function openAdmin(){
    // reset modal state
    adminPassInput.value = "";
    adminPassErr.classList.add("hidden");

    adminStepPass.classList.remove("hidden");
    adminStepTools.classList.add("hidden");

    // clear fields
    assignName.value = "";
    earnedInput.value = "";
    possibleInput.value = "";
    overrideInput.value = "";

    // show modal
    showAdmin();
    setTimeout(function(){ adminPassInput.focus(); }, 50);
  }

  // close behaviors
  adminCloseBtn1.addEventListener("click", closeAdminModal);
  adminCloseBtn2.addEventListener("click", closeAdminModal);

  adminModal.addEventListener("click", function(e){
    if(e.target === adminModal) closeAdminModal();
  });
  adminModalBox.addEventListener("click", function(e){
    e.stopPropagation();
  });

  exitAdmin.addEventListener("click", function(){
    exitAdminMode();
  });

  // unlock admin
  adminUnlockBtn.addEventListener("click", function(){
    var pass = (adminPassInput.value || "").replace(/\s+/g,"");
    if(pass !== ADMIN_PASSWORD){
      adminPassErr.classList.remove("hidden");
      return;
    }
    adminPassErr.classList.add("hidden");

    isAdminUnlocked = true; // enable delete + override

    // populate classes dropdown
    classSelect.innerHTML = "";
    for(var i=0;i<classes.length;i++){
      var opt = document.createElement("option");
      opt.value = String(classes[i].id);
      opt.textContent = classes[i].id + " - " + classes[i].name;
      classSelect.appendChild(opt);
    }

    // load current override for selected class
    overrideInput.value = getOverride(classSelect.value);

    // show tools
    adminStepPass.classList.add("hidden");
    adminStepTools.classList.remove("hidden");

    // re-render so delete buttons appear immediately
    render();

    setTimeout(function(){ assignName.focus(); }, 50);
  });

  // update override input when class changes
  classSelect.addEventListener("change", function(){
    overrideInput.value = getOverride(classSelect.value);
  });

  // save assignment (ADMIN ONLY because modal only opens after admin unlock)
  saveAssign.addEventListener("click", function(){
    if(!isAdminUnlocked) return;

    var classId = classSelect.value;
    var name = (assignName.value || "").trim();
    var earned = Number(earnedInput.value);
    var possible = Number(possibleInput.value);

    if(!name){ alert("Enter an assignment name."); return; }
    if(!isFinite(earned) || earned < 0){ alert("Points earned must be a valid number ≥ 0."); return; }
    if(!isFinite(possible) || possible <= 0){ alert("Points possible must be a valid number > 0."); return; }

    var arr = getAssignments(classId);
    arr.push({ name:name, earned:earned, possible:possible });
    setAssignments(classId, arr);

    assignName.value = "";
    earnedInput.value = "";
    possibleInput.value = "";

    render();
  });

  // save override (ADMIN ONLY)
  saveOverride.addEventListener("click", function(){
    if(!isAdminUnlocked) return;

    var classId = classSelect.value;
    var v = (overrideInput.value || "").trim();

    if(!v){
      alert("Type a letter grade (ex: A-, B+), or use Clear Override.");
      return;
    }

    setOverride(classId, v);
    render();
  });

  clearOverride.addEventListener("click", function(){
    if(!isAdminUnlocked) return;

    var classId = classSelect.value;
    setOverride(classId, "");
    overrideInput.value = "";
    render();
  });

})();
</script>
</body>
</html>
